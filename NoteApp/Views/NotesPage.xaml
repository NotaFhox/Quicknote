<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="NoteApp.Views.NotesPage"
             x:DataType="viewModels:NotesViewModel"
             xmlns:viewModels="clr-namespace:NoteApp.ViewModels"
             xmlns:models="clr-namespace:NoteApp.Models"
             Title=""
             BackgroundColor="{StaticResource WindowsBeige}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Frame Grid.Row="0" 
               Style="{StaticResource HeaderFrame}"
               Margin="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <Frame Grid.Row="0" Grid.Column="0"
                       Style="{StaticResource ContentFrame}"
                       BackgroundColor="{StaticResource SearchBackground}"
                       Margin="0,0,8,4">
                    <SearchBar Placeholder="Search your notes..."
                               Text="{Binding SearchText}"
                               SearchCommand="{Binding SearchCommand}"
                               BackgroundColor="Transparent"
                               FontFamily="Courier"
                               FontSize="12" />
                </Frame>
                
                <Button Grid.Row="0" Grid.Column="1"
                        Text="Clear"
                        Command="{Binding ClearSearchCommand}"
                        IsVisible="{Binding SearchText, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"
                        WidthRequest="60"
                        VerticalOptions="Fill"
                        FontFamily="Courier"
                        FontSize="11" />
                
                <Frame Grid.Row="1" Grid.ColumnSpan="2"
                       Style="{StaticResource ContentFrame}"
                       BackgroundColor="{StaticResource PaperWhite}"
                       Margin="0,4,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        
                        <Label Grid.Column="0" 
                               Text="Filter by Category:" 
                               VerticalOptions="Center"
                               Margin="0,0,8,0"
                               FontAttributes="Bold"
                               FontFamily="Courier"
                               FontSize="11" />
                        
                        <Picker Grid.Column="1"
                                Title="All Categories"
                                ItemsSource="{Binding Categories}"
                                SelectedItem="{Binding SelectedCategory}"
                                BackgroundColor="Transparent"
                                FontFamily="Courier"
                                FontSize="11" />
                    </Grid>
                </Frame>
            </Grid>
        </Frame>

        <ScrollView Grid.Row="1" 
                    BackgroundColor="{StaticResource ContentWhite}"
                    Margin="8">
            <StackLayout Spacing="8" Padding="8">
                <CollectionView ItemsSource="{Binding Notes}"
                                SelectionMode="None"
                                BackgroundColor="Transparent">
                    <CollectionView.EmptyView>
                        <Frame Style="{StaticResource PaperFrame}"
                               Margin="20"
                               Padding="40"
                               BackgroundColor="{StaticResource PaperWhite}">
                            <StackLayout VerticalOptions="Center" 
                                       HorizontalOptions="Center" 
                                       Spacing="16">
                                <Label Text="No notes found" 
                                       FontSize="18" 
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center"
                                       FontFamily="Courier" />
                                <Label Text="Click the 'Add Note' button below to create your first note" 
                                       TextColor="{StaticResource Gray600}" 
                                       HorizontalTextAlignment="Center"
                                       Margin="0,0,0,8"
                                       FontFamily="Courier"
                                       FontSize="12" />
                                <Button Text="Create Your First Note"
                                        Style="{StaticResource AccentButton}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:NotesViewModel}}, Path=AddNoteCommand}"
                                        HorizontalOptions="Center"
                                        FontFamily="Courier"
                                        FontSize="12" />
                            </StackLayout>
                        </Frame>
                    </CollectionView.EmptyView>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Note">
                            <Frame Style="{StaticResource PaperFrame}" 
                                   Margin="0,0,0,8"
                                   BackgroundColor="{StaticResource PaperWhite}"
                                   Padding="16">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding Title}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Black}"
                                           Margin="0,0,8,6"
                                           FontFamily="Courier"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1" />
                                    
                                    <Label Grid.Row="1" Grid.Column="0"
                                           Text="{Binding ContentPreview}"
                                           MaxLines="3"
                                           LineBreakMode="TailTruncation"
                                           TextColor="{StaticResource Gray700}"
                                           FontSize="12"
                                           Margin="0,0,8,8"
                                           FontFamily="Courier" />
                                    
                                    <Frame Grid.Row="2" Grid.Column="0"
                                           BackgroundColor="{StaticResource CategoryBackground}"
                                           BorderColor="{StaticResource Primary}"
                                           CornerRadius="0"
                                           Padding="6,3"
                                           Margin="0,0,8,6"
                                           HorizontalOptions="Start"
                                           HasShadow="False">
                                        <Label Text="{Binding Category}"
                                               Style="{StaticResource CategoryLabel}"
                                               FontSize="10"
                                               FontFamily="Courier" />
                                    </Frame>
                                    
                                    <StackLayout Grid.Row="3" Grid.Column="0"
                                               Orientation="Vertical"
                                               Spacing="2"
                                               Margin="0,0,8,0">
                                        <Label Text="{Binding TimeAgo}"
                                               Style="{StaticResource MetadataLabel}"
                                               FontSize="10"
                                               FontFamily="Courier" />
                                        <Label Text="{Binding DateModified, StringFormat='Modified: {0:dd MMM yyyy HH:mm}'}"
                                               Style="{StaticResource MetadataLabel}"
                                               FontSize="10"
                                               FontFamily="Courier" />
                                    </StackLayout>

                                    <StackLayout Grid.Row="0" Grid.Column="1" Grid.RowSpan="4"
                                               Orientation="Vertical"
                                               Spacing="8"
                                               VerticalOptions="Center"
                                               Margin="8,0,0,0">
                                        
                                        <Button Text="Edit"
                                                FontSize="10"
                                                WidthRequest="50"
                                                HeightRequest="26"
                                                Padding="4,2"
                                                BackgroundColor="{StaticResource ButtonFace}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:NotesViewModel}}, Path=SelectNoteCommand}"
                                                CommandParameter="{Binding .}"
                                                FontFamily="Courier" />
                                        
                                        <Button Text="Delete"
                                                Style="{StaticResource DangerButton}"
                                                FontSize="10"
                                                WidthRequest="50"
                                                HeightRequest="26"
                                                Padding="4,2"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:NotesViewModel}}, Path=DeleteNoteCommand}"
                                                CommandParameter="{Binding .}"
                                                FontFamily="Courier" />
                                    </StackLayout>

                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:NotesViewModel}}, Path=SelectNoteCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>
        </ScrollView>

        <Frame Grid.Row="2"
               Style="{StaticResource HeaderFrame}"
               Margin="0"
               Padding="16,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackLayout Grid.Column="0"
                           Orientation="Horizontal"
                           VerticalOptions="Center"
                           Spacing="8">
                    <Label Text="{Binding Notes.Count, StringFormat='Total notes: {0}'}"
                           VerticalOptions="Center"
                           TextColor="{StaticResource BeigeText}"
                           FontSize="11"
                           FontAttributes="Italic"
                           FontFamily="Courier" />
                </StackLayout>
                
                <Button Grid.Column="1"
                        Text="Add Note"
                        Style="{StaticResource AccentButton}"
                        FontSize="12"
                        WidthRequest="90"
                        HeightRequest="32"
                        Command="{Binding AddNoteCommand}"
                        FontFamily="Courier" />
            </Grid>
        </Frame>

        <Frame Grid.Row="1"
               IsVisible="{Binding IsBusy}"
               Style="{StaticResource ContentFrame}"
               BackgroundColor="{StaticResource PaperWhite}"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               Padding="24">
            <StackLayout Orientation="Horizontal" Spacing="12">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                 VerticalOptions="Center"
                                 Color="{StaticResource AccentBlue}" />
                <Label Text="Loading your notes..."
                       VerticalOptions="Center"
                       TextColor="{StaticResource Black}"
                       FontAttributes="Italic"
                       FontFamily="Courier"
                       FontSize="12" />
            </StackLayout>
        </Frame>
    </Grid>
</ContentPage>